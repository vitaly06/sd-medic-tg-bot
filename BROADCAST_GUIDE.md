# Система сегментированных рассылок

## Возможности сегментации

Система позволяет отправлять целевые рассылки различным группам пользователей по следующим критериям:

### 1. По региону

Отправка сообщений пользователям из конкретного региона/города:

```
регион: Москва
регион: Санкт-Петербург
регион: Краснодарский край
```

### 2. По виду ТСР

Фильтрация по видам назначенных технических средств реабилитации:

```
тср: коляска
тср: протезы
тср: ортопедическая обувь
```

### 3. По способу получения ТСР

Сегментация по способу получения:

```
способ: выдача
способ: сертификат
```

### 4. Комбинированная фильтрация

Объединение нескольких критериев для точной сегментации:

```
комбо: регион=Москва, тср=коляска
комбо: регион=Санкт-Петербург, способ=сертификат
комбо: тср=протезы, способ=выдача
```

### 5. Все пользователи

```
все
```

## Персонализация сообщений

Система поддерживает автоматическую персонализацию с использованием переменных:

### Доступные переменные:

- `{{имя}}` - имя пользователя (или username, если имя не указано)
- `{{регион}}` - регион пользователя
- `{{тср}}` - виды назначенных ТСР
- `{{дата_тср}}` - дата следующего получения ТСР

### Примеры персонализированных сообщений:

**Пример 1: Напоминание о ТСР**

```
Здравствуйте, {{имя}}!

Напоминаем, что {{дата_тср}} - день получения ваших ТСР ({{тср}}).

Не забудьте подготовить документы для получения.

С уважением,
Команда СД Медик
```

**Пример 2: Региональное мероприятие**

```
Приглашаем жителей {{регион}}!

{{имя}}, для вас запланировано мероприятие по выдаче ТСР.

Ваши назначенные ТСР: {{тср}}
```

**Пример 3: Общее информирование**

```
Уважаемый(ая) {{имя}}!

Информируем вас о новых правилах получения ТСР в {{регион}}.

Это касается следующих категорий: {{тср}}
```

## Процесс создания рассылки

1. **Админ нажимает "Рассылка"**

2. **Выбор сегмента** (broadcast_select_filter):
   - Админ вводит критерии фильтрации
   - Примеры: "все", "регион: Москва", "тср: коляска", "комбо: регион=Москва, тср=коляска"

3. **Персонализация** (broadcast_personalization):
   - Система спрашивает: "Использовать персонализацию?"
   - Админ отвечает "да" или "нет"
   - Если да - показываются доступные переменные

4. **Создание сообщения** (broadcast_message):
   - Админ отправляет текст (может использовать переменные)
   - Можно добавить фото (одно или несколько)
   - Можно добавить ссылки в тексте

5. **Подтверждение**:
   - Админ пишет "готово"
   - Система показывает количество получателей
   - Начинается рассылка

6. **Результат**:
   - Система отправляет сообщения
   - Показывает статистику: всего/успешно/ошибок
   - Указывает примененные фильтры

## Примеры использования

### Сценарий 1: Региональное уведомление

```
Сегмент: регион: Москва
Персонализация: да
Текст:
"Здравствуйте, {{имя}}!

Для жителей {{регион}} открылся новый центр выдачи ТСР по адресу ул. Примерная, д. 1.

Вы можете получить там: {{тср}}"
```

### Сценарий 2: Уведомление по типу ТСР

```
Сегмент: тср: коляска
Персонализация: да
Текст:
"{{имя}}, поступили новые модели инвалидных колясок!

Вы можете записаться на примерку по телефону +7 (XXX) XXX-XX-XX"
```

### Сценарий 3: Комбинированная рассылка

```
Сегмент: комбо: регион=Краснодар, способ=сертификат
Персонализация: да
Текст:
"Уважаемый(ая) {{имя}}!

Для жителей {{регион}}, получающих ТСР по сертификату, изменились правила оформления.

Ваши назначенные ТСР: {{тср}}
Следующая дата получения: {{дата_тср}}

Подробности на нашем сайте."
```

### Сценарий 4: Массовое информирование

```
Сегмент: все
Персонализация: нет
Текст:
"Уважаемые получатели ТСР!

С 1 января вступают в силу новые правила получения технических средств реабилитации.

Подробности: https://example.com/news"
```

## Технические детали

### Фильтрация пользователей

- Регион: поиск по вхождению подстроки (case-insensitive)
- ТСР: поиск по полю `tsrTypes` в профиле
- Способ: поиск по полю `tsrMethod` в профиле
- Комбинация: применяются все указанные фильтры (AND-логика)

### Персонализация

- Выполняется для каждого пользователя индивидуально
- Если данные отсутствуют, подставляются значения по умолчанию
- Переменные регистронезависимые

### Ограничения

- Рассылка выполняется последовательно (для избежания rate limit)
- Ошибки отправки логируются, но не прерывают рассылку
- Максимальная длина текста - ограничения Telegram API

## Статистика рассылки

После завершения рассылки администратор получает отчет:

```
✅ Рассылка завершена (регион: Москва, ТСР: коляска)!

Всего получателей: 45
Успешно отправлено: 43
Ошибок: 2

✨ Сообщения персонализированы
```

## Команды отмены

На любом этапе можно написать:

- `отмена` - отменить текущую рассылку
- Состояние будет сброшено, данные не сохранятся

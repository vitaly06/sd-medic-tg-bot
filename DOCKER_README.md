# üê≥ Docker Setup –¥–ª—è SD Medic Telegram Bot

## üìÅ –°—Ç—Ä—É–∫—Ç—É—Ä–∞

```
sd-medic-tg-bot/
‚îú‚îÄ‚îÄ Dockerfile              # Production –æ–±—Ä–∞–∑
‚îú‚îÄ‚îÄ Dockerfile.dev          # Development –æ–±—Ä–∞–∑
‚îú‚îÄ‚îÄ docker-compose.yml      # Production –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
‚îú‚îÄ‚îÄ docker-compose.dev.yml  # Development –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
‚îú‚îÄ‚îÄ .env.docker.example     # –ü—Ä–∏–º–µ—Ä –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è
‚îú‚îÄ‚îÄ docs/                   # –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è (–º–æ–Ω—Ç–∏—Ä—É–µ—Ç—Å—è –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä)
‚îî‚îÄ‚îÄ dumps/                  # SQL –¥–∞–º–ø—ã (–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∏–º–ø–æ—Ä—Ç–∏—Ä—É—é—Ç—Å—è)
    ‚îî‚îÄ‚îÄ dump.sql
```

## üöÄ –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç

### Production

1. **–°–∫–æ–ø–∏—Ä—É–π—Ç–µ –ø—Ä–∏–º–µ—Ä env —Ñ–∞–π–ª–∞:**

```bash
cp .env.docker.example .env
```

2. **–û—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä—É–π—Ç–µ `.env` –∏ –¥–æ–±–∞–≤—å—Ç–µ —Å–≤–æ–π Telegram Bot Token:**

```env
TELEGRAM_BOT_TOKEN=your_actual_bot_token_here
DB_PASSWORD=secure_password_here
```

3. **–ó–∞–ø—É—Å—Ç–∏—Ç–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã:**

```bash
docker-compose up -d
```

4. **–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏:**

```bash
docker-compose logs -f bot
```

5. **–û—Å—Ç–∞–Ω–æ–≤–∫–∞:**

```bash
docker-compose down
```

### Development (—Å –≥–æ—Ä—è—á–µ–π –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–æ–π)

1. **–ù–∞—Å—Ç—Ä–æ–π—Ç–µ `.env` –∫–∞–∫ –≤ Production**

2. **–ó–∞–ø—É—Å—Ç–∏—Ç–µ dev –≤–µ—Ä—Å–∏—é:**

```bash
docker-compose -f docker-compose.dev.yml up
```

3. **–ò–∑–º–µ–Ω–µ–Ω–∏—è –≤ –∫–æ–¥–µ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è**

## üì¶ –ß—Ç–æ –≤–∫–ª—é—á–µ–Ω–æ –≤ Docker –æ–±—Ä–∞–∑

### Production –æ–±—Ä–∞–∑ (`Dockerfile`)

- ‚úÖ –°–æ–±—Ä–∞–Ω–Ω–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ (dist/)
- ‚úÖ Prisma Client (src/generated/)
- ‚úÖ Production –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
- ‚úÖ Prisma —Å—Ö–µ–º–∞ (prisma/)
- ‚úÖ **–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è (docs/)**
- ‚úÖ **SQL –¥–∞–º–ø—ã (dumps/)**
- ‚úÖ Markdown —Ñ–∞–π–ª—ã –∏–∑ –∫–æ—Ä–Ω—è (README.md, BROADCAST_GUIDE.md –∏ —Ç.–¥.)
- ‚úÖ –î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è –¥–ª—è Excel —ç–∫—Å–ø–æ—Ä—Ç–∞ (exports/)

### –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö (PostgreSQL)

- ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –∏–º–ø–æ—Ä—Ç SQL –¥–∞–º–ø–æ–≤ –∏–∑ `dumps/`
- ‚úÖ Healthcheck –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏
- ‚úÖ Persistent volume –¥–ª—è –¥–∞–Ω–Ω—ã—Ö

## üóÇÔ∏è Volumes (–º–æ–Ω—Ç–∏—Ä—É–µ–º—ã–µ –ø–∞–ø–∫–∏)

### Production

```yaml
volumes:
  - ./exports:/app/exports # Excel —Ñ–∞–π–ª—ã —ç–∫—Å–ø–æ—Ä—Ç–∞
  - ./docs:/app/docs:ro # –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è (read-only)
  - ./dumps:/app/dumps:ro # SQL –¥–∞–º–ø—ã (read-only)
```

### Development

```yaml
volumes:
  - .:/app # –í–µ—Å—å –ø—Ä–æ–µ–∫—Ç (–≥–æ—Ä—è—á–∞—è –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞)
  - /app/node_modules # node_modules –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ
  - ./exports:/app/exports # Excel —Ñ–∞–π–ª—ã
```

## üìä –ò–º–ø–æ—Ä—Ç SQL –¥–∞–º–ø–∞

SQL –¥–∞–º–ø –∏–∑ `dumps/dump.sql` **–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∏–º–ø–æ—Ä—Ç–∏—Ä—É–µ—Ç—Å—è** –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –∑–∞–ø—É—Å–∫–µ PostgreSQL –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞.

–ï—Å–ª–∏ –Ω—É–∂–Ω–æ –ø–µ—Ä–µ–∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å:

```bash
# –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∏ —É–¥–∞–ª–∏—Ç—å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã —Å –¥–∞–Ω–Ω—ã–º–∏
docker-compose down -v

# –ó–∞–ø—É—Å—Ç–∏—Ç—å –∑–∞–Ω–æ–≤–æ (–¥–∞–º–ø –∏–º–ø–æ—Ä—Ç–∏—Ä—É–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏)
docker-compose up -d
```

## üîß –ü–æ–ª–µ–∑–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã

### –ü—Ä–æ—Å–º–æ—Ç—Ä –ª–æ–≥–æ–≤

```bash
# –í—Å–µ —Å–µ—Ä–≤–∏—Å—ã
docker-compose logs -f

# –¢–æ–ª—å–∫–æ –±–æ—Ç
docker-compose logs -f bot

# –¢–æ–ª—å–∫–æ –±–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö
docker-compose logs -f postgres
```

### –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ —Å–µ—Ä–≤–∏—Å–æ–≤

```bash
# –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å –≤—Å—ë
docker-compose restart

# –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å —Ç–æ–ª—å–∫–æ –±–æ—Ç–∞
docker-compose restart bot
```

### –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –∫–æ–º–∞–Ω–¥ –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ

```bash
# Prisma –º–∏–≥—Ä–∞—Ü–∏–∏
docker-compose exec bot yarn prisma migrate dev

# Prisma Studio
docker-compose exec bot yarn prisma studio

# –ó–∞–π—Ç–∏ –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
docker-compose exec bot sh
```

### –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö

```bash
# –ò–∑ —Ö–æ—Å—Ç–∞
psql -h localhost -U postgres -d SdMedic

# –ò–∑ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
docker-compose exec postgres psql -U postgres -d SdMedic
```

### –≠–∫—Å–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö

```bash
# –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π –¥–∞–º–ø
docker-compose exec postgres pg_dump -U postgres SdMedic > dumps/dump_$(date +%Y%m%d).sql
```

### –û—á–∏—Å—Ç–∫–∞

```bash
# –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∏ —É–¥–∞–ª–∏—Ç—å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã
docker-compose down

# –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∏ —É–¥–∞–ª–∏—Ç—å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã + volumes (–£–î–ê–õ–ò–¢ –î–ê–ù–ù–´–ï –ë–î!)
docker-compose down -v

# –£–¥–∞–ª–∏—Ç—å –æ–±—Ä–∞–∑—ã
docker-compose down --rmi all
```

## üåê –ü–æ—Ä—Ç—ã

- **3000** - NestJS –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ (–µ—Å–ª–∏ –Ω—É–∂–µ–Ω HTTP)
- **5432** - PostgreSQL –±–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö

## üìù –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è

| –ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è           | –û–ø–∏—Å–∞–Ω–∏–µ            | –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é |
| -------------------- | ------------------- | ------------ |
| `TELEGRAM_BOT_TOKEN` | –¢–æ–∫–µ–Ω Telegram –±–æ—Ç–∞ | -            |
| `DB_NAME`            | –ò–º—è –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö     | SdMedic      |
| `DB_USER`            | –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ë–î     | postgres     |
| `DB_PASSWORD`        | –ü–∞—Ä–æ–ª—å –ë–î           | postgres     |
| `DB_PORT`            | –ü–æ—Ä—Ç –ë–î             | 5432         |
| `NODE_ENV`           | –û–∫—Ä—É–∂–µ–Ω–∏–µ           | production   |

## üîí –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

**–í–∞–∂–Ω–æ –¥–ª—è Production:**

1. **–ò–∑–º–µ–Ω–∏—Ç–µ –ø–∞—Ä–æ–ª—å –ë–î** –≤ `.env`:

```env
DB_PASSWORD=your_very_secure_password_here
```

2. **–ù–µ –∫–æ–º–º–∏—Ç—å—Ç–µ `.env` —Ñ–∞–π–ª** (—É–∂–µ –≤ .gitignore)

3. **–û–≥—Ä–∞–Ω–∏—á—å—Ç–µ –¥–æ—Å—Ç—É–ø –∫ –ø–æ—Ä—Ç–∞–º**:

```yaml
# –í–º–µ—Å—Ç–æ
ports:
  - "5432:5432"

# –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ (–¥–æ—Å—Ç—É–ø —Ç–æ–ª—å–∫–æ —Å —Ö–æ—Å—Ç–∞)
ports:
  - "127.0.0.1:5432:5432"
```

## üêõ Troubleshooting

### –ü—Ä–æ–±–ª–µ–º–∞: –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –Ω–µ –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è

```bash
# –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏
docker-compose logs postgres

# –£–¥–∞–ª–∏—Ç–µ volume –∏ –ø–µ—Ä–µ—Å–æ–∑–¥–∞–π—Ç–µ
docker-compose down -v
docker-compose up -d
```

### –ü—Ä–æ–±–ª–µ–º–∞: –ë–æ—Ç –Ω–µ –ø–æ–¥–∫–ª—é—á–∞–µ—Ç—Å—è –∫ –ë–î

```bash
# –ü—Ä–æ–≤–µ—Ä—å—Ç–µ healthcheck
docker-compose ps

# –£–±–µ–¥–∏—Ç–µ—Å—å —á—Ç–æ DATABASE_URL –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π
docker-compose exec bot env | grep DATABASE_URL
```

### –ü—Ä–æ–±–ª–µ–º–∞: –ò–∑–º–µ–Ω–µ–Ω–∏—è –Ω–µ –ø—Ä–∏–º–µ–Ω—è—é—Ç—Å—è (Dev)

```bash
# –ü–µ—Ä–µ—Å–æ–±–µ—Ä–∏—Ç–µ –æ–±—Ä–∞–∑
docker-compose -f docker-compose.dev.yml up --build
```

## üìà –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

### –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–¥–æ—Ä–æ–≤—å—è –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤

```bash
docker-compose ps
```

### –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Ä–µ—Å—É—Ä—Å–æ–≤

```bash
docker stats
```

## üîÑ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è

### Production

```bash
# –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Ç–µ–∫—É—â—É—é –≤–µ—Ä—Å–∏—é
docker-compose down

# –ü–æ–ª—É—á–∏—Ç—å –Ω–æ–≤—ã–π –∫–æ–¥
git pull

# –ü–µ—Ä–µ—Å–æ–±—Ä–∞—Ç—å –∏ –∑–∞–ø—É—Å—Ç–∏—Ç—å
docker-compose up -d --build
```

### –ë–µ–∑ –ø—Ä–æ—Å—Ç–æ—è (Rolling update)

```bash
# –ü–µ—Ä–µ—Å–æ–±—Ä–∞—Ç—å –æ–±—Ä–∞–∑
docker-compose build bot

# –ó–∞–ø—É—Å—Ç–∏—Ç—å –Ω–æ–≤—ã–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
docker-compose up -d --no-deps --build bot
```

## üìö –î–æ—Å—Ç—É–ø –∫ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏ –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ

–í—Å—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –¥–æ—Å—Ç—É–ø–Ω–∞ –≤–Ω—É—Ç—Ä–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞:

```bash
# –ü—Ä–æ—Å–º–æ—Ç—Ä —Å—Ç—Ä—É–∫—Ç—É—Ä—ã docs
docker-compose exec bot ls -la /app/docs

# –ü—Ä–æ—Å–º–æ—Ç—Ä README
docker-compose exec bot cat /app/README.md

# –ü—Ä–æ—Å–º–æ—Ç—Ä —Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤–∞ –ø–æ —Ä–∞—Å—Å—ã–ª–∫–∞–º
docker-compose exec bot cat /app/BROADCAST_GUIDE.md
```

## üéØ Best Practices

1. **Development**: –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ `docker-compose.dev.yml` –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏
2. **Production**: –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ `docker-compose.yml` –¥–ª—è –ø—Ä–æ–¥–∞–∫—à–µ–Ω–∞
3. **Backups**: –†–µ–≥—É–ª—è—Ä–Ω–æ –¥–µ–ª–∞–π—Ç–µ backup –ë–î (`pg_dump`)
4. **Logs**: –ù–∞—Å—Ç—Ä–æ–π—Ç–µ —Ä–æ—Ç–∞—Ü–∏—é –ª–æ–≥–æ–≤ –¥–ª—è production
5. **Security**: –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ Docker secrets –¥–ª—è —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
6. **Updates**: –†–µ–≥—É–ª—è—Ä–Ω–æ –æ–±–Ω–æ–≤–ª—è–π—Ç–µ –±–∞–∑–æ–≤—ã–µ –æ–±—Ä–∞–∑—ã

## üìû –ü–æ–¥–¥–µ—Ä–∂–∫–∞

–ü—Ä–∏ –≤–æ–∑–Ω–∏–∫–Ω–æ–≤–µ–Ω–∏–∏ –ø—Ä–æ–±–ª–µ–º:

1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏: `docker-compose logs`
2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å—Ç–∞—Ç—É—Å: `docker-compose ps`
3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –ë–î
4. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ `.env` —Ñ–∞–π–ª
